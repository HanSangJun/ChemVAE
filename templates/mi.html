<!DOCTYPE html>
<html lang="en">

<head>

  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  <meta name="description" content="">
  <meta name="author" content="">

  <title>LG Sciencepark</title>

  <!-- Bootstrap core CSS -->
  <link href="{{ url_for('static', filename='bootstrap/css/bootstrap.min.css') }}" rel="stylesheet">

  <!-- Custom styles for this template -->
  <link href="{{ url_for('static', filename='simple-sidebar.css') }}" rel="stylesheet">

  <!-- Google fonts -->
  <link href="https://fonts.googleapis.com/css?family=Noto+Sans+KR&display=swap" rel="stylesheet">

  <style>
    body {font-family: 'Noto Sans KR';}
    #step1 {height: 410px;}
    @media (min-width: 992px) {
      .modal-lg {
          width: 1400px;
          height: 1200px;
          max-width: 1400px;
          max-height: 1200px;
      }
    }
    video {margin-left: 30px;}
  </style>

</head>

<body>

  <div class="d-flex" id="wrapper">

    <!-- Sidebar -->
    <div class="bg-light border-right" id="sidebar-wrapper">
      <div class="sidebar-heading"><strong>LG Sciencepark</strong></div>
      <div class="list-group list-group-flush">
        <!-- <a href="/" class="list-group-item list-group-item-action bg-light">Predictive Maintenance</a> -->
        <a href="#" class="list-group-item list-group-item-action bg-light">Lead Generation</a>
        <a href="#" class="list-group-item list-group-item-action bg-light" data-toggle="modal" data-target=".bd-example-modal-lg">Lead Optimization</a>
        <div class="modal fade bd-example-modal-lg" tabindex="-1" role="dialog" aria-labelledby="myLargeModalLabel" aria-hidden="true">
          <div class="modal-dialog modal-lg">
            <div class="modal-content">
              <div class="modal-header">
                <h2 class="modal-title" id="exampleModalLongTitle"><strong>Lead Optimization</strong></h2>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                  <span aria-hidden="true">&times;</span>
                </button>
              </div>
              <div class="modal-body">
                <video width="1300" controls autoplay>
                  <source src="{{ url_for('static', filename='videos/demo4.mp4') }}" type="video/mp4">
                </video>
              </div>
            </div>
          </div>
        </div>
        <a href="#" class="list-group-item list-group-item-action bg-light">Overview</a>
        <a href="#" class="list-group-item list-group-item-action bg-light">Events</a>
        <a href="#" class="list-group-item list-group-item-action bg-light">Profile</a>
        <a href="#" class="list-group-item list-group-item-action bg-light">Status</a>
      </div>
    </div>
    <!-- /#sidebar-wrapper -->

    <!-- Page Content -->
    <div id="page-content-wrapper">
      <nav class="navbar navbar-expand-lg navbar-light bg-light border-bottom">
        <button class="btn btn-primary" id="menu-toggle">Menu</button>

        <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarSupportedContent" aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
          <span class="navbar-toggler-icon"></span>
        </button>

        <div class="collapse navbar-collapse" id="navbarSupportedContent">
          <ul class="navbar-nav ml-auto mt-2 mt-lg-0">
            <li class="nav-item active">
              <a class="nav-link" href="#">Home <span class="sr-only">(current)</span></a>
            </li>
            <li class="nav-item">
              <a class="nav-link" href="#">Link</a>
            </li>
            <li class="nav-item dropdown">
              <a class="nav-link dropdown-toggle" href="#" id="navbarDropdown" role="button" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                Dropdown
              </a>
              <div class="dropdown-menu dropdown-menu-right" aria-labelledby="navbarDropdown">
                <a class="dropdown-item" href="#">Action</a>
                <a class="dropdown-item" href="#">Another action</a>
                <div class="dropdown-divider"></div>
                <a class="dropdown-item" href="#">Something else here</a>
              </div>
            </li>
          </ul>
        </div>
      </nav>

      <div class="container-fluid mb-5" id="title">
        <h2 class="mt-4"><strong>Lead Generation</strong></h2>
        <h5 class="mt-4">본 데모는 미리 학습된 화합물 데이터를 바탕으로
                         우리가 원하는 물성을 가진 새 화합물을 생성합니다.</h5>
        <img src="{{ url_for('static', filename='images/model2.jpg') }}" width="580", height="220">
      </div>

      <div class="container-fluid" id="step1">
        <h5 class="mt-4"><strong>Step 1.</strong> 원하는 질병과 대표 약물을 선택하세요.</h5>
        <div class="row">
          <div class="col-md-4">
            <div class="input-group mb-1">
              <select class="custom-select col-12" id="chemical">
                <option selected>Choose...</option>
                <option value="C1CN2C(=NN=C2C(F)(F)F)CN1C(=O)C[C@@H](CC3=CC(=C(C=C3F)F)F)N">당뇨 - Sitagliptin</option>
                <option value="C1C[C@H](N(C1)C(=O)CNC23CC4CC(C2)CC(C4)(C3)O)C#N">당뇨 - Vildagliptin</option>
                <option value="CC1=CN=C(C=N1)C(=O)NCCC2=CC=C(C=C2)S(=O)(=O)NC(=O)NC3CCCCC3">당뇨 - Glpizide</option>
                <option value="CC(C)C1CCC(CC1)C(=O)N[C@H](CC2=CC=CC=C2)C(=O)O">당뇨 - Nateglinide</option>
                <option value="CCN(C)C(=O)OC1=CC=CC(=C1)[C@H](C)N(C)C">알츠하이머 - Rivastigmine</option>
                <option value="C1=CC2=C(C(=C(C=C2Cl)I)O)N=C1">알츠하이머 - Clioquinol</option>
                <option value="CO[C@@H](C)c1c(NC(=O)Nc2cnc(c(Cl)c2)-n2nccn2)cnc2cc(Cl)nn12">항암/면역 - JP1</option>
                <option value="C[C@H]1COC[C@H](C)N1c1c(NC(=O)Nc2ccnc(c2)C(F)(F)F)cnc2cc(Cl)nn12">항암/면역 - NP1</option>
                <option value="COC(C)c1c(NC(=O)Nc2cnc(c(Cl)c2)-n2nccn2)cnc2ccc(F)cc12">항암/면역 - NP2</option>
              </select>
              <div class="input-group-append">
                <button class="btn btn-outline-secondary" type="button" id="generate">Generate</button>
              </div>
            </div>
            <div>
              <strong>화합물의 구조는 SMILES 형식으로 표시됩니다.</strong></br>
              SMILES(Simplified Molecular Input Line Entry System)란?</br>
              화학 구조를 컴퓨터가 인식할 수 있는 문자열로 변환한 표기법
            </div>
          </div>
          <div class="col-md-8">
            <div class="row" id="choosed"></div>
          </div>
        </div>
        <!-- <div class="input-group mb-5">
          <input type="text" class="form-control col-3" id="chemical" placeholder="Chemical here" aria-label="chemical" aria-describedby="basic-addon2">
          <div class="input-group-append">
            <button class="btn btn-outline-secondary" type="button">Button</button>
          </div>
        </div> -->
      </div>

      <div class="container-fluid" id="step2">
        <!-- Contents -->
        <h5 class="mt-4"><strong>Step 2.</strong> 원하는 성능에 맞는 후보 물질을 생성합니다. 결과를 확인하세요.</h5>
        <!-- <label id="pred"></label> -->
        <div class="row" id="results"></div>
      </div>
    </div>
    <!-- /#page-content-wrapper -->

  </div>
  <!-- /#wrapper -->

  <!-- Bootstrap core JavaScript -->
  <script src="{{ url_for('static', filename='jquery/jquery.min.js') }}"></script>
  <script src="{{ url_for('static', filename='bootstrap/js/bootstrap.bundle.min.js') }}"></script>

  <!-- Smiles Drawer-->
  <script src="https://unpkg.com/smiles-drawer@1.0.10/dist/smiles-drawer.min.js"></script>

  <!-- Menu Toggle Script -->
  <script>
  // toggle menu
  $("#menu-toggle").click(function(e) {
    e.preventDefault();
    $("#wrapper").toggleClass("toggled");
  });

  // detect change event on select and draw SMILES
  $('select').on('change', function(e) {
    var optionSelected = $("option:selected", this);
    var smiles = this.value;

    var options = {width: 334, height: 206};
    var smilesDrawer = new SmilesDrawer.Drawer(options);

    $('#choosed').empty(); // clear
    $('#choosed').append('<div class="col-md-4"> \
                            <div class="card"> \
                              <canvas id="choosed-smiles"></canvas> \
                              <div class="card-body"> \
                                <h5 class="card-title">' + smiles + '</h5> \
                                <p class="card-text" id="choosed-prop"></p> \
                              </div> \
                            </div> \
                          </div>');

    SmilesDrawer.parse(smiles, function(tree) {
      smilesDrawer.draw(tree, 'choosed-smiles', 'light', false);
    });

    $.ajax({
        url: '/mi/property',
        data: {'smiles': smiles},
        type: 'POST',
        success: function(response) {
          response = $.parseJSON(response);
          logp = parseFloat(response['logp']).toFixed(2)
          sa = parseFloat(response['sa']).toFixed(2)
          $('#choosed-prop').html('용해성(LogP) : ' + logp + ', 합성용이성(SA) : ' + sa);
        },
        error: function(error) {
          alert('물성 계산에 오류가 있습니다.');
          console.log(error);
        }
      });
  });

  function drawResponse(response, i) {
    // results
    var count = i.toString();
    $('#results').append('<div class="col-md-3" style="padding-bottom: 20px"> \
                            <div class="card" id="results' + count + '"> \
                              <canvas id="smiles' + count + '"></canvas> \
                              <div class="card-body"> \
                                <h5 class="card-title" id="results_smiles' + count + '"></h5> \
                                <p class="card-text" id="results_prop' + count + '"></p> \
                                <p class="card-text" id="results_dist_prob' + count + '"></p> \
                              </div> \
                            </div> \
                          </div>');
    // SMILES init
    var parent_width = $('#smiles' + count).parent().width();
    var parent_height = $('#smiles' + count).parent().height();

    var options = {width: parent_width, height: parent_height};
    var smilesDrawer = new SmilesDrawer.Drawer(options);
    var smiles = response['smiles'][i];

    SmilesDrawer.parse(smiles, function(tree) {
      smilesDrawer.draw(tree, 'smiles' + count, 'light', false);
    });
    
    var logp = parseFloat(response['logp'][i]).toFixed(2);
    var sa = parseFloat(response['sa'][i]).toFixed(2);
    var dist = parseFloat(response['dist'][i]).toFixed(2);
    var freq = (parseFloat(response['freq'][i]) * 100).toFixed(2);
    
    $('#results_smiles' + count).html(smiles);
    $('#results_prop' + count).html('용해성(LogP) : ' + logp + ', 합성용이성(SA) : ' + sa);
    $('#results_dist_prob' + count).html('선택한 대표 약물과의 유사성이 \
                                          <strong>' + dist.toString() + '%</strong>입니다.');
  }

  // ajax with chemicalVAE
  $(function() {
    $('#generate').click(function() {
      var response;
      var chemical = $('#chemical').val();
      $('button').attr('disabled', true); // button unactivate

      $.ajax({
        url: '/mi/generate',
        data: {'smiles': chemical},
        type: 'POST',
        async: false,
        success: function(response_ajax) {
          $('#pred').val(''); // clear
          $('#results').empty(); // clear
          response = $.parseJSON(response_ajax);
          var qed = parseFloat(response['pred'][0]).toFixed(2);
          var sas = parseFloat(response['pred'][1]).toFixed(2);
          var logp = parseFloat(response['pred'][2]).toFixed(2);

          // properties
          // $('#pred').text('Reference 물성 예측치 - QED: ' + qed.toString() + ', SAS: ' + sas.toString() + ', logP: ' + logp.toString());
        },
        error: function(error) {
          alert('SMILES 규칙에 위반되거나 기학습된 데이터로 생성할 수 없습니다.');
          $('button').attr('disabled', false); // button unactivate
          console.log(error);
        }
      });
      
      // drawing results with delay
      for(let i=0;i<response['smiles'].length;i++) {
        setTimeout(function() {
          drawResponse(response, i);

          // move to step2 smoothly
          if(i%4 == 0) {
            var pos = $('#results' + i.toString()).offset();
            $('html, body').stop().animate({scrollTop: pos.top}, 1500);
          }

          if(i == response['smiles'].length-1) {
            $('button').attr('disabled', false); // button activate
          }
        }, i*2000+(Math.random()*800));
      }
    });
  });
  </script>

</body>

</html>
